<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>package-structure • lambdr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="package-structure">
<meta property="og:description" content="lambdr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">lambdr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/api-gateway-invocations.html">API Gateway Invocations</a>
    </li>
    <li>
      <a href="../articles/context.html">Using invocation context</a>
    </li>
    <li>
      <a href="../articles/lambda-runtime-in-container.html">Placing an R Lambda Runtime in a Container</a>
    </li>
    <li>
      <a href="../articles/package-structure.html">package-structure</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mdneuzerling/lambdr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>package-structure</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mdneuzerling/lambdr/blob/master/vignettes/package-structure.Rmd"><code>vignettes/package-structure.Rmd</code></a></small>
      <div class="hidden name"><code>package-structure.Rmd</code></div>

    </div>

    
    
<div id="package-structure-and-operating-method" class="section level2">
<h2 class="hasAnchor">
<a href="#package-structure-and-operating-method" class="anchor"></a>Package structure and operating method</h2>
<p>This vignette provides an overview of how the package is structures and how the functions are used. It is intended for package developers and contributors.</p>
<div id="runtime-endpoints" class="section level3">
<h3 class="hasAnchor">
<a href="#runtime-endpoints" class="anchor"></a>Runtime endpoints</h3>
<p>The runtime works by querying HTTP endpoints configured by AWS Lambda. These endpoints are determined by on the “AWS_LAMBDA_RUNTIME_API” environment variable set by AWS Lambda during initialisation. They generally won’t be available locally.</p>
<ul>
<li>The <strong>next invocation endpoint</strong> is the endpoint which R must query for the next input. R must send a <code>GET</code> request to this endpoint and will wait until either a response is received or the Lambda instance is shut down for inactivity. When AWS Lambda receives an input from, say, an API Gateway, it will respond to R’s request with details of the input. We call the response to this request an <em>invocation</em> in this document, and invocations are interpreted as <em>events</em>.</li>
<li>The <strong>initialisation error endpoint</strong> is where an error should be sent if the error occurs when setting up the runtime. This is distinct from errors that occur during handling of an event.</li>
<li>The <strong>response endpoint</strong> is where an event response should be sent. It is unique for each event.</li>
<li>The <strong>invocation error endpoint</strong> is where errors that occur during event handling should be reported. It is unique for each event.</li>
</ul>
<p>The next invocation and initialisation error endpoints are unique in each Lambda instance. The response and invocation error endpoints are determined by the <code>request_id</code> associated with each invocation. The request ID is given in the “lambda-runtime-aws-request-id” header in the response to the query to the next invocation endpoint.</p>
</div>
<div id="handler-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#handler-functions" class="anchor"></a>Handler functions</h3>
<p>Every Lambda instance is centred around a single function which handles any inputs. The <em>handler function</em> is determined by an environment variable which can be configured in one of two ways:</p>
<ul>
<li>as the <code>CMD</code> to the Dockerfile which contains the runtime, or</li>
<li>as configured through the Lambda console (this takes precedence)</li>
</ul>
<p>The <code>lambda_config</code> function (run as part of <code>start_lambda</code>) picks up on this environment variable and identifies the R function to which it refers. This handler function is used to process all invocations.</p>
</div>
<div id="event-classification-according-to-invocation" class="section level3">
<h3 class="hasAnchor">
<a href="#event-classification-according-to-invocation" class="anchor"></a>Event classification according to invocation</h3>
<p>Events need to be handled differently depending upon whether they are invoked directly, by an API Gateway, etc. Events are classified according to their detected invocation method, with their invocation stored as an S3 class. The following functions dispatch on this class:</p>
<ul>
<li>
<code>parse_event_content</code> converts the raw event content into arguments to be passed to the handler function</li>
<li>
<code>seralise_result</code> converts the result into the form that will be sent back to Lambda</li>
<li>
<code>extract_context</code> extracts metadata about the event as a list. If the handler function accepts a named <code>context</code> argument then it will receive the context as a value to that argument.</li>
<li>
<code>handle_event_error</code> deals with errors that occur during event handling. Some invocation types require errors to be formatted or handled in a very specific way.</li>
</ul>
</div>
<div id="event-listening-lifecycle" class="section level3">
<h3 class="hasAnchor">
<a href="#event-listening-lifecycle" class="anchor"></a>Event listening lifecycle</h3>
<p>The main function — <code>start_lambda</code> — accepts an optional configuration provided by <code>lambda_config</code>. The default configuration should suffice if the handler is configured in either the Dockerfile or the <em>AWS Lambda</em> console. It will then run the internal <code>start_listening</code> function.</p>
<p>The <code>start_listening</code> function will augment the configuration with context extracted from the environment (using the <code>extract_context_from_environment</code> function). It will then set up an infinite loop that listens for <em>invocations</em>, interprets them as <em>events</em>, and processes them with the handler function.</p>
<p>Specifically, <code>start_listening</code> triggers the listening loop, which consists of <code>wait_for_event</code> and <code>handle_event</code> (combined into <code>wait_for_and_handle_event</code>). Once a response (called an <em>invocation</em>) is sent to the request made in <code>wait_for_event</code>, it is <em>decomposed</em> into an <em>event</em>, and classified according to its (detected) invocation type.</p>
<p>If an error occurs during this stage it is handled by <code>handle_decomposition_error</code>. If possible the error will be posted to the error invocation endpoint so that Lambda can process it, but otherwise it will simply be logged and then the runtime will move onto the next invocation.</p>
<p>The event is passed to <code>handle_event</code> which consists of the following steps:</p>
<ul>
<li>
<code>parse_event_content</code> interprets the event content as arguments to be handed to the handler function. The user can also provide a function to the <code>deseraliser</code> argument of <code>start_listening</code> (or <code>start_lambda</code>), which will override the standard parsing logic.</li>
<li>
<code>generate_result</code> passes these arguments to the handler function and generates a result. If the function accepts a named <code>context</code> argument the <code>generate_result</code> will call on <code>extract_and_augment_context</code> to generate the invocation context and pass it to the handler function in addition to the arguments.</li>
<li>
<code>serialise_result</code> converts the result into the response that will be sent to Lambda. The user can also provide a function to the <code>serialiser</code> argument of <code>start_listening</code> (or <code>start_lambda</code>), which will override the standard serialisation logic.</li>
<li>
<code>post_result</code> posts the serialised result to the response endpoint.</li>
</ul>
<p>Afterwards, the runtime will return to the <code>wait_for_event</code> function and process the next invocation that arrives. AWS Lambda may shut down the instance if it times out before another event invocation arrives.</p>
<p>Alternatively, if an error occurs during <code>wait_for_event</code> it will be handled by <code>handle_decomposition_error</code>, or if it occurs during <code>handle_event</code> it will be dispatched to the appropriate <code>handle_event_error</code> method according to the S3 class of the event. In either case this will not stop the R session — an error when processing a single event is a problem for that event alone. The runtime will return to the <code>wait_for_event</code> step.</p>
<p>All of these functions are diagrammed below, with boxes representing functions which are grouped together according to the primary function that calls each of them in sequence. Errors are shown in red.</p>
<p><img src="start-listening.drawio.svg"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by David Neuzerling.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
